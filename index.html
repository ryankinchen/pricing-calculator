<script>
    // 1. DATA MAPPING: Defines the canonical services for packages and add-ons.
    const basePackageServices = {
        'highlight': ['aerial-video', 'ground-interior-video'],
        'aerial-ground-stills': ['aerial-stills', 'ground-exterior'],
        'aerial-only': ['aerial-stills'],
        'aerial-video': ['aerial-video'],
        'interior-stills': ['ground-interior-stills'],
        'interior-video': ['ground-interior-video']
    };

    const addonToService = {
        'aerial-stills': 'aerial-stills',
        'aerial-video-addon': 'aerial-video',
        'ground-exterior': 'ground-exterior',
        'ground-interior-stills': 'ground-interior-stills',
        'ground-interior-video': 'ground-interior-video'
    };

    const serviceDisplayNames = {
        'aerial-stills': 'Aerial Photography (20+ images)',
        'aerial-video': 'Aerial Video (Orbit + Flyby + Approach)',
        'ground-exterior': 'Ground Exterior Photography',
        'ground-interior-stills': 'Interior Photography (up to 40 images)',
        'ground-interior-video': 'Interior Video (multiple clips)'
    };

    // 2. PRICING TABLE: The single source of truth for all valid service combinations.
    const serviceCombinationPrices = {
        // Single services
        'aerial-stills': 400,
        'aerial-video': 450,
        'ground-interior-stills': 550,
        'ground-interior-video': 600,
        'aerial-stills,ground-exterior': 500,
        'aerial-video,ground-interior-video': 600,

        // Two services (10% discount)
        'aerial-stills,aerial-video': 600,
        'aerial-stills,ground-interior-stills': 650,
        'aerial-stills,ground-interior-video': 675,
        'aerial-video,ground-interior-stills': 700,
        'ground-interior-stills,ground-interior-video': 825,

        // Three services (20% discount)
        'aerial-stills,aerial-video,ground-exterior': 725,
        'aerial-stills,aerial-video,ground-interior-stills': 800,
        'aerial-stills,aerial-video,ground-interior-video': 825,
        'aerial-stills,ground-exterior,ground-interior-stills': 775,
        'aerial-stills,ground-exterior,ground-interior-video': 800,
        'aerial-stills,ground-interior-stills,ground-interior-video': 950,
        'aerial-video,ground-exterior,ground-interior-stills': 825, // Note: This key seems to have services out of alpha order in the prompt, but the logic will handle it.
        'aerial-video,ground-exterior,ground-interior-video': 850, // Same as above.
        'aerial-video,ground-interior-stills,ground-interior-video': 1000,
        'ground-exterior,ground-interior-stills,ground-interior-video': 925, // Same as above.

        // Four services (30% discount)
        'aerial-stills,aerial-video,ground-exterior,ground-interior-stills': 975,
        'aerial-stills,aerial-video,ground-exterior,ground-interior-video': 1000,
        'aerial-stills,aerial-video,ground-interior-stills,ground-interior-video': 1125,
        'aerial-stills,ground-exterior,ground-interior-stills,ground-interior-video': 1075,
        'aerial-video,ground-exterior,ground-interior-stills,ground-interior-video': 1125,

        // Five services (40% discount)
        'aerial-stills,aerial-video,ground-exterior,ground-interior-stills,ground-interior-video': 1275
    };

    // 3. STATE MANAGEMENT: Holds the current user selections.
    let selectedPackageId = null;
    let selectedAddons = []; // Stores objects: {id, name}
    let finalPrice = 0;
    let finalServices = []; // Stores the final list of service display names

    // 4. EVENT LISTENERS: Handle user interaction.
    document.querySelectorAll('.package-card').forEach(card => {
        card.addEventListener('click', function() {
            const packageId = this.dataset.package;
            if (this.classList.contains('selected')) {
                // Deselect current package
                this.classList.remove('selected');
                selectedPackageId = null;
            } else {
                // Select new package
                document.querySelectorAll('.package-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedPackageId = packageId;
            }
            updateSummary();
        });
    });

    document.querySelectorAll('.addon-item').forEach(item => {
        item.addEventListener('click', function() {
            const addonId = this.dataset.addon;
            const addonName = this.querySelector('.addon-name').textContent;
            const isSelected = this.classList.toggle('selected');

            if (isSelected) {
                selectedAddons.push({ id: addonId, name: addonName });
            } else {
                selectedAddons = selectedAddons.filter(addon => addon.id !== addonId);
            }
            updateSummary();
        });
    });

    // 5. CORE LOGIC: The arbitrage-free calculation and UI rendering function.
    function updateSummary() {
        const summaryContent = document.getElementById('summary-content');
        const contactBtn = document.getElementById('contact-btn');

        if (!selectedPackageId) {
            summaryContent.innerHTML = '<div class="empty-state">Select a base package to get started</div>';
            contactBtn.disabled = true;
            finalPrice = 0;
            finalServices = [];
            return;
        }

        // STEP 1: Build a complete, unique set of all selected services.
        const allServices = new Set();
        basePackageServices[selectedPackageId].forEach(service => allServices.add(service));
        selectedAddons.forEach(addon => allServices.add(addonToService[addon.id]));

        // STEP 2: Create the normalized lookup key by sorting alphabetically.
        const sortedServices = Array.from(allServices).sort();
        const lookupKey = sortedServices.join(',');

        // STEP 3: Perform a direct lookup in the pricing table.
        finalPrice = serviceCombinationPrices[lookupKey];
        finalServices = sortedServices.map(key => serviceDisplayNames[key]);

        // --- DEBUG LOGS (as requested in spec) ---
        console.clear();
        console.log("--- DEBUG INFO ---");
        console.log("Selected Package ID:", selectedPackageId);
        console.log("Selected Addon IDs:", selectedAddons.map(a => a.id));
        console.log("Final Service Set:", sortedServices);
        console.log("Normalized Lookup Key:", lookupKey);
        console.log("Returned Price:", finalPrice);
        console.log("--------------------");
        // --- END DEBUG LOGS ---

        // STEP 4: Display the results.
        if (finalPrice === undefined) {
            summaryContent.innerHTML = '<div class="empty-state" style="color: #c0392b;">This combination is not available. Please adjust your selections or contact us for a custom quote.</div>';
            contactBtn.disabled = true;
            return;
        }

        let html = '<h4>Your Package Includes:</h4><ul style="list-style-position: inside; padding-left: 10px; margin-top: 10px;">';
        finalServices.forEach(serviceName => {
            html += `<li style="margin-bottom: 5px;">${serviceName}</li>`;
        });
        html += '</ul>';

        html += `<div class="summary-total">Total: $${finalPrice}</div>`;

        summaryContent.innerHTML = html;
        contactBtn.disabled = false;
    }

    // 6. EMAIL GENERATION: Creates a pre-filled email with the final quote.
    function contactUs() {
        if (!selectedPackageId || finalPrice === 0) {
            alert('Please select a valid package combination first!');
            return;
        }

        let serviceList = '';
        finalServices.forEach(service => {
            serviceList += `• ${service}%0A`;
        });

        const subject = `Commercial Imaging Quote Request - $${finalPrice}`;
        const body = `Hi Ryan,%0A%0AI'm interested in getting a quote for the following imaging services:%0A%0A${serviceList}%0A━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━%0AESTIMATED TOTAL: $${finalPrice}%0A━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━%0A%0APROJECT DETAILS:%0A(Please fill out below)%0A%0AProperty Address: %0A%0AProperty Type: (Warehouse/Commercial/Industrial/Other)%0A%0ADistance from Fontana: %0A%0AAdditional Notes: %0A%0AThank you!`;

        window.open(`mailto:ryan@lumair.app?subject=${subject}&body=${body}`);
    }
</script>

